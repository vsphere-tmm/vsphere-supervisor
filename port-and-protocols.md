# Supervisor and VKS ports and protocols

This document addresses the common ports and protocols that are required for the various components of the SUpervisor stack to work efficiently. The document is specific to the following stack - 
- vSphere 8.0U3 (VCF 5.2.1)
- AVi Essentials (and Enterprise) 22.1.x (as deployed within a VDS setup)
- Supervisor v1.27 - v1.29 (as shipped with vSphere 8.0U3)

It should be noted that while the ports mentioned here are specific to the VDS deployment, the communication patterns are quite similar for an NSX-based deployment. Except for communication between vCenter and NSX (not captured here), the other components would initiate communication via a similar pattern. The document is divided into six categories/groups. Each group is a set of ports and protocols for a specific part/group of the platform. All traffic flow should be considered bi-directional. 

Additionally, while we have documented the traffic flow between individual IPs within a pool of IPs (that would be in the same subnet), firewall ports may not need to be opened for these flows. These are marked as "Optional" and are for documentation purposes only. 

The Supervisor and VKS can operate in a completely air-gapped environment. As highlighted in the flows, the Internet egress traffic would need to be replaced by relevant endpoints (such as container registries hosting images) in the air-gapped/firewalled environment.

The table below describes the various IP Pools and Network segments referenced later in this document.


| Network / IP Pool                                                                                        | Description                                                                                                                                                                                                                                                                                                                                                                                                       |
| -------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| AVI Controller(s)                                                                                        | The primary IP address of all the AVi Controllers(s)                                                                                                                                                                                                                                                                                                                                                              |
| AVI SE Mgmt IP Pool                                                                                      | The IP Pool from which AVi Service Engines get their Management IP addresses.                                                                                                                                                                                                                                                                                                                                     |
| AVI SE VIP Pool (including Supervisor, VKS, and Application VIP (running on VKS and Supervisor)          | The IP Pool from which the Load Balancer VIPs are created.                                                                                                                                                                                                                                                                                                                                                        |
| AVI SE vNIC pool                                                                                         | The IP Pool from which the Avi Service Engines get the secondary vNIC IP addresses. In most scenarios, the VIP Pool and the vNIC pools are shared.                                                                                                                                                                                                                                                                |
| Internal Service                                                                                         | These are Kubernetes-specific Internal IP address pools that are not generally exposed to the public network.                                                                                                                                                                                                                                                                                                     |
| Supervisor Mgmt IP Pool (including the VIP)                                                              | This IP Pool is a set of 5 contiguous IPs from which the Supervisor CPVM management IPs (including the VIP) are allocated.                                                                                                                                                                                                                                                                                        |
| Primary Workload Network IP Pool (including Supervisor CPVM and vSPhere Pod running Supervisor Services) | This IP Pool allocates IPs for the Secondary (workload) network connection to the Supervisor CPVM and all vSphere PODs.                                                                                                                                                                                                                                                                                           |
| Secondary Workload Network IP Pool (VKS CPVM and VM)                                                     | The Secondary Workload Network(s) are workload networks attached to vSphere Namespaces. The VKS Cluster nodes (CPVM and VM) reside on this network. Users can often use the Primary Workload Network (see above) to deploy VKS clusters within appropriately configured vSphere Namespaces. In these scenarios, replace the Secondary Workload Network with the Primary Workload Network in the connection flows. |


## Group AVi

In this group, we provide details of all the traffic flows originating from the various AVi components (including the AVi Controller and the Service Engines). Note that these flows are only relevant to the Supervisor and VKS communication. For a complete list of AVi ports and protocols, please refer to the products' official guidance and documentation.

| Port Display          | Protocol | Source              | Destination                                                     | Mandatory/Optional | Notes                                                                                                                                  |
| ---------------------: | :--------: | ------------------- | --------------------------------------------------------------- | :------------------: | -------------------------------------------------------------------------------------------------------------------------------------- |
| 443                   | TCP      | AVI Controller(s)   | ESXi Server(s) Mgmt IP                                          | Mandatory          |                                                                                                                                        |
|                       |          |                     |                                                                 |                    |                                                                                                                                        |
| 123                   | UDP      | AVI SE Mgmt IP Pool | AVI SE Mgmt IP Pool                                             | Optional           | This traffic is generally allowed within a contiguous pool of IPs and may not require a firewall request. Referenced for doc purposes. |
| 22, 123(UDP), 8443    | TCP      | AVI SE Mgmt IP Pool | AVI Controller(s)                                               | Mandatory          |                                                                                                                                        |
|                       |          |                     |                                                                 |                    |                                                                                                                                        |
| 80, 443, xxx          | TCP      | AVI SE vNIC pool    | Secondary Workload Network IP Pool (VKS VM)                     | Mandatory          | Applications Ingress on VKS clusters                                                                                                   |
| 6443                  | TCP      | AVI SE vNIC pool    | Secondary Workload Network IP Pool (VKS CPVM)                   | Mandatory          | Kubectl access to VKS                                                                                                                  |
| 443, 2112, 2113, 6443 | TCP      | AVI SE vNIC pool    | Primary Workload Network IP Pool (Supervisor CPVM)              | Mandatory          | Kubectl access to Supervisor                                                                                                           |
| 8080, 8443            | TCP      | AVI SE vNIC pool    | Primary Workload Network IP Pool (Supervisor Service - Contour) | Mandatory          | Ingress access to Supervisor                                                                                                           |

## Group Client

In this group, we provide details of all the traffic flows originating from the client/jumphost/bastion machines as they access the various components of the platform such as CLI, UI and application access. 

| Port         | Protocol | Source          | Destination                                                       | Mandatory/Optional | Notes                                                |
| ------------: | :--------: | --------------- | ----------------------------------------------------------------- | :------------------: | ---------------------------------------------------- |
| 123          | UDP      | Client/Jumphost | NTP                                                               | Mandatory          | Must be enabled during initial infrastructure setup. |
| 22, 443      | TCP      | Client/Jumphost | VCenter                                                           | Mandatory          | vCenter UI and CLI access                            |
| 443          | TCP      | Client/Jumphost | AVI SE VIP pool - Supervisor VIP                                  | Mandatory          | Ingress to Supervisor kube-api                       |
| 6443         | TCP      | Client/Jumphost | AVI SE VIP pool - VKS VIP                                         | Mandatory          | Ingress to VKS kube-api                              |
| 80, 443, xxx | TCP      | Client/Jumphost | AVI SE VIP Pool - Application VIP (running on VKS and Supervisor) | Mandatory          | Ingress to applications                              |

## Group Infrastructure

In this group, we provide details of all the traffic flows originating from the platform's various infrastructure components (such as ESXi and vCenter). These components must be comprehensively installed and configured before enabling the Supervisor.

| Port                | Protocol | Source                 | Destination                                           | Mandatory/Optional | Notes                                                                                                                                  |
| -------------------: | :--------: | ---------------------- | ----------------------------------------------------- | :------------------: | -------------------------------------------------------------------------------------------------------------------------------------- |
| 53                  | UDP, TCP | ESXi Server(s) Mgmt IP | DNS                                                   | Mandatory          | Must be enabled during initial infrastructure setup.                                                                                   |
| 123                 | UDP      | ESXi Server(s) Mgmt IP | NTP                                                   | Mandatory          | Must be enabled during initial infrastructure setup.                                                                                   |
| 6443                | TCP      | ESXi Server(s) Mgmt IP | Supervisor Mgmt IP Pool (VIP)\*                       | Mandatory          | Supervisor Mgmt IP Pool (VIP) is the floating IP in the Supervisor Mgmt IP Pool. This is for document purposes only.                   |
| 10250               | TCP      | ESXi Server(s) Mgmt IP | Primary Workload Network IP Pool (Supervisor Service) | Mandatory          |                                                                                                                                        |
|                     |          |                        |                                                       |                    |                                                                                                                                        |
| 443                 | TCP      | vCenter                | Internet                                              | Optional           | Egress Internet traffic. It may not be required for an airgapped setup. If so, would need private endpoints for corresponding services |
| 443, 902, 9080      | TCP      | vCenter                | ESXi Server(s) Mgmt IP                                | Mandatory          | Must be enabled during initial infrastructure setup.                                                                                   |
| 443, 6443           | TCP      | vCenter                | Supervisor Mgmt IP Pool                               |                    |                                                                                                                                        |
| 22, 443, 5000, 6443 | TCP      | vCenter                | Supervisor Mgmt IP Pool (VIP)\*                       | Mandatory          | Supervisor Mgmt IP Pool (VIP) is the floating IP in the Supervisor Mgmt IP Pool. This is for document purposes only.                   |


## Group Supervisor

In this group, we provide details of all the traffic flows originating from the Supervisory Control Plane VMs (including the flows from both networks to which these VMs are connected). These flows are critical for the optimal platform installation, configuration, and LCM.  

| Port                                                                                                                                                                                                    | Protocol | Source                                             | Destination                                                                | Mandatory/Optional | Notes                                                                                                                                                                                                                                                                             |
| -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------: | :--------: | -------------------------------------------------- | -------------------------------------------------------------------------- | :------------------: | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 53                                                                                                                                                                                                      | UDP, TCP | Supervisor Mgmt IP Pool                            | DNS                                                                        | Mandatory          |                                                                                                                                                                                                                                                                                   |
| 123                                                                                                                                                                                                     | UDP      | Supervisor Mgmt IP Pool                            | NTP                                                                        | Mandatory          |                                                                                                                                                                                                                                                                                   |
| 443                                                                                                                                                                                                     | TCP      | Supervisor Mgmt IP Pool                            | AVI Controller(s)                                                          | Mandatory          |                                                                                                                                                                                                                                                                                   |
| 443                                                                                                                                                                                                     | TCP      | Supervisor Mgmt IP Pool                            | Internal Service - kube-apiserver                                          | Optional           | This traffic (though internal) has been observed at the firewalls. Firewall requests may need to "ALLOW" this traffic                                                                                                                                                             |
| 443                                                                                                                                                                                                     | TCP      | Supervisor Mgmt IP Pool                            | projects.packages.broadcom.com and redirect to S3 buckets, Internet - Misc | Optional           | Optional Egress Internet Traffic (see notes) for installing supervisor services directly from Internet. IP ranges for S3 are in https://ip-ranges.amazonaws.com/ip-ranges.json and are subject to change. See https://docs.aws.amazon.com/vpc/latest/userguide/aws-ip-ranges.html |
| 443                                                                                                                                                                                                     | TCP      | Supervisor Mgmt IP Pool                            | vCenter                                                                    | Mandatory          |                                                                                                                                                                                                                                                                                   |
| 6443                                                                                                                                                                                                    | TCP      | Supervisor Mgmt IP Pool                            | Supervisor Mgmt IP Pool (VIP)\*                                            | Optional           | This traffic is generally allowed within a contiguous pool of IPs and may not require a firewall request. Referenced for doc purposes.                                                                                                                                            |
| 443, 2379, 2380, 5000, 6443                                                                                                                                                                             | TCP      | Supervisor Mgmt IP Pool                            | Supervisor Mgmt IP Pool                                                    | Optional           | This traffic is generally allowed within a contiguous pool of IPs and may not require a firewall request. Referenced for doc purposes.                                                                                                                                            |
|                                                                                                                                                                                                         |          |                                                    |                                                                            |                    |                                                                                                                                                                                                                                                                                   |
| 53                                                                                                                                                                                                      | UDP, TCP | Primary Workload Network IP Pool (Supervisor CPVM) | DNS                                                                        | Mandatory          |                                                                                                                                                                                                                                                                                   |
| 123                                                                                                                                                                                                     | UDP      | Primary Workload Network IP Pool (Supervisor CPVM) | NTP                                                                        | Mandatory          |                                                                                                                                                                                                                                                                                   |
| 6443                                                                                                                                                                                                    | TCP      | Primary Workload Network IP Pool (Supervisor CPVM) | Secondary Workload Network IP Pool (VKS CPVM)                              | Mandatory          |                                                                                                                                                                                                                                                                                   |
| 6443                                                                                                                                                                                                    | TCP      | Primary Workload Network IP Pool (Supervisor CPVM) | Supervisor Mgmt IP Pool                                                    | Mandatory          |                                                                                                                                                                                                                                                                                   |
| 8053                                                                                                                                                                                                    | TCP      | Primary Workload Network IP Pool (Supervisor CPVM) | Primary Workload Network IP Pool (Supervisor Service - LCI)                | Optional           | This traffic is generally allowed within a contiguous pool of IPs and may not require a firewall request. Referenced for doc purposes.                                                                                                                                            |
| 53(UDP), 2112 ,2113, 6443, 8000, 8099, 8443, 9402, 9442, 9443, 9855, 9874, 9875, 9877, 9878, 9879, 9880, 9883, 9886, 9887, 9897, 9898, 10250, 10350, 12000, 12002, 18310, 18313, 10000-19999, 9800-9899 | TCP      | Primary Workload Network IP Pool (Supervisor CPVM) | Primary Workload Network IP Pool (Supervisor CPVM)                         | Optional           | This traffic is generally allowed within a contiguous pool of IPs and may not require a firewall request. Referenced for doc purposes.                                                                                                                                            |


## Group Supervisor Services

In this group, we provide details of all the traffic flows originating from the various Supervisor Services that can be installed and configured on the Supervisor. We have provided flows for three sample services: Contour, Harbor, and LCI. The last set of ports and protocols is standard for all supervisor services. Note that most of the Supervisor Services are deployed as vSphere Pods on the ESXi servers.

| Port                   | Protocol | Source                                                                                     | Destination                                                     | Mandatory/Optional | Notes                                                                                                                                                                                                                                                                             |
| ----------------------: | :--------: | ------------------------------------------------------------------------------------------ | --------------------------------------------------------------- |:------------------: | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 8001                   | TCP      | Primary Workload Network IP Pool (Supervisor Service - Contour)                            | Internal Service - Internal svc                                 | Optional           | This traffic (though internal) has been observed at the firewalls. Firewall requests may need to "ALLOW" this traffic                                                                                                                                                             |
| 8001                   | TCP      | Primary Workload Network IP Pool (Supervisor Service - Contour)                            | Primary Workload Network IP Pool (Supervisor Service - Contour) | Optional           | This traffic is generally allowed within a contiguous pool of IPs and may not require a firewall request. Referenced for doc purposes.                                                                                                                                            |
| 53(UDP), 6443          | UDP      | Primary Workload Network IP Pool (Supervisor Service - Contour)                            | Primary Workload Network IP Pool (Supervisor CPVM)              | Optional           | This traffic is generally allowed within a contiguous pool of IPs and may not require a firewall request. Referenced for doc purposes.                                                                                                                                            |
|                        |          |                                                                                            |                                                                 |                    |                                                                                                                                                                                                                                                                                   |
| 53                     | UDP, TCP | Primary Workload Network IP Pool (Supervisor Service - Harbor)                             | Primary Workload Network IP Pool (Supervisor CPVM)              | Optional           | This traffic is generally allowed within a contiguous pool of IPs and may not require a firewall request. Referenced for doc purposes.                                                                                                                                            |
| 5432, 5443, 6379, 8443 | TCP      | Primary Workload Network IP Pool (Supervisor Service - Harbor)                             | Internal Service - Internal K8s svc                             | Optional           | This traffic (though internal) has been observed at the firewalls. Firewall requests may need to "ALLOW" this traffic                                                                                                                                                             |
| 5432, 5443, 6379, 8443 | TCP      | Primary Workload Network IP Pool (Supervisor Service - Harbor)                             | Primary Workload Network IP Pool (Supervisor Service - Harbor)  | Optional           | This traffic is generally allowed within a contiguous pool of IPs and may not require a firewall request. Referenced for doc purposes.                                                                                                                                            |
|                        |          |                                                                                            |                                                                 |                    |                                                                                                                                                                                                                                                                                   |
| 443                    | TCP      | Primary Workload Network IP Pool (Supervisor Service - LCI)                                | Internal Service - Internal K8s svc                             | Optional           | This traffic (though internal) has been observed at the firewalls. Firewall requests may need to "ALLOW" this traffic                                                                                                                                                             |
| 53(UDP), 443, 6443     | TCP      | Primary Workload Network IP Pool (Supervisor Service - LCI)                                | Primary Workload Network IP Pool (Supervisor CPVM)              | Optional           | This traffic is generally allowed within a contiguous pool of IPs and may not require a firewall request. Referenced for doc purposes.                                                                                                                                            |
|                        |          |                                                                                            |                                                                 |                    |                                                                                                                                                                                                                                                                                   |
| 53                     | UDP, TCP | Primary Workload Network IP Pool (Supervisor Service - Common for all Supervisor Services) | Internal Service - CoreDNS                                      | Optional           | This traffic (though internal) has been observed at the firewalls. Firewall requests may need to "ALLOW" this traffic                                                                                                                                                             |
| 443                    | TCP      | Primary Workload Network IP Pool (Supervisor Service - Common for all Supervisor Services) | Internal Service - kube-apiserver                               | Optional           | This traffic (though internal) has been observed at the firewalls. Firewall requests may need to "ALLOW" this traffic                                                                                                                                                             |
| 443                    | TCP      | Primary Workload Network IP Pool (Supervisor Service - Common for all Supervisor Services) | projects.packages.broadcom.com and redirect to S3 buckets       | Optional           | Optional Egress Internet Traffic (see notes) for installing supervisor services directly from Internet. IP ranges for S3 are in https://ip-ranges.amazonaws.com/ip-ranges.json and are subject to change. See https://docs.aws.amazon.com/vpc/latest/userguide/aws-ip-ranges.html |

## Group VKS (Workload) Clusters

In this group, we provide details of all the traffic flows originating from the VKS clusters (comprising Control Plane VMs - CPVMs - and worker nodes VMs) deployed in vSphere Namespaces. Each vSphere Namespace can have a distinct "Workload Network" attached to it, and the VKS nodes are connected to this network/segment.

| Port                                                                                                                          | Protocol | Source                                        | Destination                                   | Mandatory/Optional | Notes                                                                                                                                  |
| -----------------------------------------------------------------------------------------------------------------------------: | :--------: | --------------------------------------------- | --------------------------------------------- | :------------------: | -------------------------------------------------------------------------------------------------------------------------------------- |
| 53                                                                                                                            | UDP, TCP | Secondary Workload Network IP Pool (VKS CPVM) | DNS                                           | Mandatory          |                                                                                                                                        |
| 123                                                                                                                           | UDP      | Secondary Workload Network IP Pool (VKS CPVM) | NTP                                           | Mandatory          |                                                                                                                                        |
| 443                                                                                                                           | TCP      | Secondary Workload Network IP Pool (VKS CPVM) | Internal Service - kube-apiserver             | Optional           | This traffic (though internal) has been observed at the firewalls. Firewall requests may need to "ALLOW" this traffic                  |
| 6443                                                                                                                          | TCP      | Secondary Workload Network IP Pool (VKS CPVM) | AVI SE VIP pool - Supervisor VIP              | Mandatory          |                                                                                                                                        |
| 6443                                                                                                                          | TCP      | Secondary Workload Network IP Pool (VKS CPVM) | AVI SE VIP pool - VKS VIP                     | Mandatory          |                                                                                                                                        |
| 10250, 10351, 10351(UDP), 10000-19999, 10000-19999(UDP)                                                                       | TCP      | Secondary Workload Network IP Pool (VKS CPVM) | Secondary Workload Network IP Pool (VKS VM)   | Optional           | This traffic is generally allowed within a contiguous pool of IPs and may not require a firewall request. Referenced for doc purposes. |
| 179(Calico), 2379, 2380, 5473(Calico), 6081(UDP), 6443, 10100, 10250, 10349, 10351, 10351(UDP), 10000-19999, 10000-19999(UDP) | TCP      | Secondary Workload Network IP Pool (VKS CPVM) | Secondary Workload Network IP Pool (VKS CPVM) | Optional           | This traffic is generally allowed within a contiguous pool of IPs and may not require a firewall request. Referenced for doc purposes. |
|                                                                                                                               |          |                                               |                                               |                    |                                                                                                                                        |
| 53                                                                                                                            | UDP, TCP | Secondary Workload Network IP Pool (VKS VM)   | DNS                                           | Mandatory          |                                                                                                                                        |
| 123                                                                                                                           | UDP      | Secondary Workload Network IP Pool (VKS VM)   | Internet - NTP                                | Mandatory          | Not sure                                                                                                                               |
| 123                                                                                                                           | UDP      | Secondary Workload Network IP Pool (VKS VM)   | NTP                                           | Mandatory          |                                                                                                                                        |
| 443                                                                                                                           | TCP      | Secondary Workload Network IP Pool (VKS VM)   | Internet - Misc                               | Optional           | Egress Internet traffic. It may not be required for an airgapped setup. If so, would need private endpoints for corresponding services |
| 6443                                                                                                                          | TCP      | Secondary Workload Network IP Pool (VKS VM)   | AVI SE VIP pool - Supervisor VIP              | Mandatory          |                                                                                                                                        |
| 6443                                                                                                                          | TCP      | Secondary Workload Network IP Pool (VKS VM)   | AVI SE VIP pool - VKS VIP                     | Mandatory          |                                                                                                                                        |
| 179(Calico), 5473(Calico), 10351, 10351(UDP), 10000-19999, 10000-19999(UDP)                                                   | TCP      | Secondary Workload Network IP Pool (VKS VM)   | Secondary Workload Network IP Pool (VKS VM)   | Optional           | This traffic is generally allowed within a contiguous pool of IPs and may not require a firewall request. Referenced for doc purposes. |
| 6443, 10349, 10351, 10351(UDP), 10000-19999, 10000-19999(UDP)                                                                 | TCP      | Secondary Workload Network IP Pool (VKS VM)   | Secondary Workload Network IP Pool (VKS CPVM) | Optional           | This traffic is generally allowed within a contiguous pool of IPs and may not require a firewall request. Referenced for doc purposes. |

